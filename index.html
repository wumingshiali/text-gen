<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊñáÂ≠óÊ∏≤ÊüìÂô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Segoe UI Web (West European)', -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
            background: #f3f3f3;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #1f1f1f;
        }

        .container {
            display: flex;
            flex: 1;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            gap: 12px;
            padding: 12px;
        }

        /* Â∑¶‰æßÂàóË°®Âå∫Âüü */
        .left-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .panel-title {
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            color: #1f1f1f;
            font-size: 15px;
            font-weight: 600;
        }

        .text-input-area {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .input-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .input-item-number {
            width: 32px;
            height: 32px;
            background: #0078d4;
            color: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
            font-size: 13px;
        }

        .input-item input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid rgba(0, 0, 0, 0.13);
            border-radius: 4px;
            font-size: 13px;
            transition: all 0.15s ease-out;
            background: rgba(255, 255, 255, 0.95);
            font-family: inherit;
        }

        .input-item input:hover {
            border-color: rgba(0, 0, 0, 0.16);
            background: white;
        }

        .input-item input:focus {
            outline: none;
            border-color: #0078d4;
            background: white;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.1);
        }

        .input-item button {
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.06);
            color: #1f1f1f;
            border: 1px solid rgba(0, 0, 0, 0.13);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease-out;
            font-size: 13px;
            font-family: inherit;
        }

        .input-item button:hover {
            background: rgba(0, 0, 0, 0.09);
            border-color: rgba(0, 0, 0, 0.16);
        }

        .input-item button:active {
            background: rgba(0, 0, 0, 0.12);
        }

        .add-btn {
            width: 100%;
            padding: 8px;
            background: #0078d4;
            color: white;
            border: 1px solid #0078d4;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.15s ease-out;
            margin-top: 8px;
            font-family: inherit;
        }

        .add-btn:hover {
            background: #1084d7;
            border-color: #1084d7;
        }

        .add-btn:active {
            background: #0066b2;
            border-color: #0066b2;
        }

        /* Âè≥‰æßÈÄâÈ°πÂå∫Âüü */
        .right-panel {
            width: 280px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .option-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .option-label {
            font-weight: 500;
            color: #1f1f1f;
            font-size: 13px;
        }

        .font-select-wrapper {
            position: relative;
        }

        .font-search {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid rgba(0, 0, 0, 0.13);
            border-radius: 4px;
            font-size: 13px;
            transition: all 0.15s ease-out;
            background: rgba(255, 255, 255, 0.95);
            font-family: inherit;
            color: #1f1f1f;
        }

        .font-search:hover {
            border-color: rgba(0, 0, 0, 0.16);
            background: white;
        }

        .font-search:focus {
            outline: none;
            border-color: #0078d4;
            background: white;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.1);
        }

        .font-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.13);
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .font-dropdown.show {
            display: block;
        }

        .font-option {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.1s;
        }

        .font-option:hover {
            background: rgba(0, 120, 212, 0.1);
        }

        .font-option.selected {
            background: rgba(0, 120, 212, 0.2);
        }

        /* ÈÄöÁî®‰∏ãÊãâÊ°ÜÊ†∑Âºè */
        .select-wrapper {
            position: relative;
        }

        .select-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid rgba(0, 0, 0, 0.13);
            border-radius: 4px;
            font-size: 13px;
            transition: all 0.15s ease-out;
            background: rgba(255, 255, 255, 0.95);
            font-family: inherit;
            color: #1f1f1f;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .select-input:hover {
            border-color: rgba(0, 0, 0, 0.16);
            background: white;
        }

        .select-input:focus {
            outline: none;
            border-color: #0078d4;
            background: white;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.1);
        }

        .select-arrow {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-right: 2px solid currentColor;
            border-bottom: 2px solid currentColor;
            transform: rotate(45deg);
            margin-left: 8px;
            transition: transform 0.15s;
        }

        .select-wrapper.open .select-arrow {
            transform: rotate(-135deg);
        }

        .select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.13);
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .select-dropdown.show {
            display: block;
        }

        .select-option {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.1s;
        }

        .select-option:hover {
            background: rgba(0, 120, 212, 0.1);
        }

        .select-option.selected {
            background: rgba(0, 120, 212, 0.2);
            color: #0078d4;
            font-weight: 500;
        }

        /* ‰∏ãÊñπÊåâÈíÆÂå∫Âüü */
        .footer {
            padding: 12px 20px;
            display: flex;
            justify-content: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.6);
            border-top: 1px solid rgba(0, 0, 0, 0.06);
        }

        .render-btn {
            padding: 10px 36px;
            background: #0078d4;
            color: white;
            border: 1px solid #0078d4;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease-out;
            font-family: inherit;
        }

        .render-btn:hover:not(:disabled) {
            background: #1084d7;
            border-color: #1084d7;
        }

        .render-btn:active:not(:disabled) {
            background: #0066b2;
            border-color: #0066b2;
        }

        .render-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .download-btn {
            padding: 10px 36px;
            background: #107c10;
            color: white;
            border: 1px solid #107c10;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease-out;
            display: none;
            font-family: inherit;
        }

        .download-btn:hover {
            background: #128012;
            border-color: #128012;
        }

        .download-btn:active {
            background: #0c5a0c;
            border-color: #0c5a0c;
        }

        /* ËøõÂ∫¶Êù° */
        .progress-container {
            width: 300px;
            display: none;
            flex-direction: column;
            gap: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(0, 0, 0, 0.13);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #0078d4;
            width: 0%;
            transition: width 0.2s ease-out;
            border-radius: 2px;
        }

        .progress-text {
            color: white;
            font-size: 13px;
            text-align: center;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }

            .right-panel {
                width: 100%;
            }
        }

        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.13);
            border-radius: 6px;
            border: 3px solid transparent;
            background-clip: content-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.16);
            border: 3px solid transparent;
            background-clip: content-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Â∑¶‰æßÔºöÊñáÂ≠óËæìÂÖ•ÂàóË°® -->
        <div class="left-panel">
            <div class="panel-title">ÊñáÂ≠óÂàóË°®</div>
            <div class="text-input-area" id="textList">
                <div class="input-item">
                    <div class="input-item-number">1</div>
                    <input type="text" placeholder="ËæìÂÖ•Ë¶ÅÊ∏≤ÊüìÁöÑÊñáÂ≠ó..." value="">
                    <button onclick="removeItem(this)">Âà†Èô§</button>
                </div>
            </div>
            <div style="padding: 12px;">
                <button class="add-btn" onclick="addItem()">Ê∑ªÂä†Êñ∞È°π</button>
            </div>
        </div>

        <!-- Âè≥‰æßÔºöÈÄâÈ°πÈù¢Êùø -->
        <div class="right-panel">
            <div class="option-group">
                <label class="option-label">Â≠ó‰Ωì</label>
                <div style="display: flex; gap: 6px;">
                    <div class="font-select-wrapper" style="flex: 1;">
                        <input type="text" class="font-search" id="fontSearch" placeholder="ÊêúÁ¥¢ÊàñËæìÂÖ•Â≠ó‰ΩìÂêç...">
                        <div class="font-dropdown" id="fontDropdown"></div>
                    </div>
                    <button style="padding: 8px 12px; background: #0078d4; color: white; border: 1px solid #0078d4; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.15s; font-family: inherit;" onclick="addCustomFont()" title="Ê∑ªÂä†Ëá™ÂÆö‰πâÂ≠ó‰Ωì">+</button>
                    <button style="padding: 8px 12px; background: #0078d4; color: white; border: 1px solid #0078d4; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.15s; font-family: inherit;" onclick="document.getElementById('fontFileInput').click()" title="‰∏ä‰º†Â≠ó‰ΩìÊñá‰ª∂">üìÅ</button>
                    <input type="file" id="fontFileInput" accept=".ttf,.otf,.woff,.woff2" style="display: none;" onchange="uploadFontFile(event)">
                </div>
                <input type="hidden" id="fontFamily" value="">
            </div>

            <div class="option-group">
                <label class="option-label">Â≠óÂè∑</label>
                <input type="number" id="fontSize" min="12" max="300" value="48" step="1">
            </div>

            <div class="option-group">
                <label class="option-label">ËæìÂá∫Ê†ºÂºè</label>
                <div class="select-wrapper" id="formatWrapper">
                    <div class="select-input" id="formatInput">WebP (Êé®Ëçê)<span class="select-arrow"></span></div>
                    <div class="select-dropdown" id="formatDropdown"></div>
                </div>
                <input type="hidden" id="format" value="webp">
            </div>
        </div>
    </div>

    <!-- ‰∏ãÊñπÔºöÊìç‰ΩúÊåâÈíÆÂå∫Âüü -->
    <div class="footer">
        <button class="render-btn" id="renderBtn" onclick="startRender()">ÂºÄÂßãÊ∏≤Êüì</button>
        <button class="download-btn" id="downloadBtn" onclick="downloadZip()">‰∏ãËΩΩ ZIP</button>
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">ÂáÜÂ§á‰∏≠...</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // Â≠ó‰ΩìÊ£ÄÊµãÂ∫ì - ‰ΩøÁî®ÁúüÂÆûÁöÑ FontFaceSet API
        class FontDetector {
            constructor() {
                this.fonts = [];
            }

            // Ëé∑ÂèñÁ≥ªÁªüÂ≠ó‰ΩìÂàóË°® - ÁúüÂÆû API
            async detectSystemFonts() {
                // ‰ΩøÁî® CSS Â≠ó‰ΩìÂä†ËΩΩ API
                if (document.fonts && document.fonts.ready) {
                    try {
                        await document.fonts.ready;
                        console.log('CSS Fonts Â∑≤Â∞±Áª™');
                    } catch (e) {
                        console.log('CSS Fonts ÈîôËØØ:', e);
                    }
                }

                // Áõ¥Êé•‰ΩøÁî®ÊµèËßàÂô®Êèê‰æõÁöÑÂ≠ó‰ΩìÂàóË°®
                this.detectInstalledFonts();
            }

            // ÁúüÊ≠£Ê£ÄÊµãÂ∑≤ÂÆâË£ÖÁöÑÂ≠ó‰Ωì
            detectInstalledFonts() {
                const canvas = document.createElement('canvas');
                canvas.width = 500;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');

                // ‰ΩøÁî®‰∏Ä‰∏™Áã¨ÁâπÁöÑÊµãËØïÂ≠óÁ¨¶‰∏≤
                const testString = 'yWQm√±√°';  // ÂåÖÂê´ÂêÑÁßçÂ≠óÁ¨¶
                const fontSize = '40px';

                // Ëé∑ÂèñÂü∫ÂáÜÂ≠ó‰ΩìÂÆΩÂ∫¶
                ctx.font = `${fontSize} monospace`;
                const baselineWidth = ctx.measureText(testString).width;

                // Ëé∑ÂèñÊâÄÊúâ CSS Â≠ó‰Ωì
                const fontStack = [];

                // ‰ªé document.fonts ËØªÂèñÂ∑≤Âä†ËΩΩÁöÑÂ≠ó‰Ωì
                if (document.fonts && document.fonts.size > 0) {
                    for (const font of document.fonts) {
                        fontStack.push(font.family);
                    }
                }

                // Ê∑ªÂä†Á≥ªÁªüÂ≠ó‰Ωì
                const systemFonts = this.getSystemFonts();
                
                // ÊµãËØïÊØè‰∏™Â≠ó‰Ωì
                const detectedFonts = new Set();

                // ÂêàÂπ∂ÊâÄÊúâË¶ÅÊ£ÄÊµãÁöÑÂ≠ó‰Ωì
                const allFonts = new Set([...fontStack, ...systemFonts]);

                console.log(`Ê£ÄÊµã‰∏≠... ÊÄªÂÖ± ${allFonts.size} ‰∏™Â≠ó‰Ωì`);
                console.log('Âü∫ÂáÜÂÆΩÂ∫¶ (monospace):', baselineWidth);

                // ÁâπÂà´ÂÖ≥Ê≥® Minecraft AE
                const minecraftFonts = ['Minecraft AE', 'MinecraftAE', 'Minecraft-AE', 'minecraft ae', 'minecraftae'];

                allFonts.forEach(fontName => {
                    try {
                        // Áî®ËØ•Â≠ó‰ΩìÊµãÈáèÂÆΩÂ∫¶
                        ctx.font = `${fontSize} "${fontName}", monospace`;
                        const width = ctx.measureText(testString).width;

                        // ÂÆΩÂ∫¶Â∑ÆÂºÇ
                        const diff = Math.abs(width - baselineWidth);

                        // Â¶ÇÊûúÊòØ Minecraft Áõ∏ÂÖ≥ÔºåËæìÂá∫ËØ¶ÁªÜ‰ø°ÊÅØ
                        if (fontName.toLowerCase().includes('minecraft')) {
                            console.log(`>>> ${fontName}: ÂÆΩÂ∫¶=${width.toFixed(2)}, Â∑ÆÂºÇ=${diff.toFixed(2)}px`);
                        }

                        // Â¶ÇÊûúÂÆΩÂ∫¶‰∏çÂêåÔºåËØ¥ÊòéÂ≠ó‰ΩìÂ∑≤Â∫îÁî®
                        if (diff > 2) {
                            detectedFonts.add(fontName);
                            console.log(`‚úì Ê£ÄÊµãÂà∞: ${fontName} (Â∑ÆÂºÇ: ${diff.toFixed(2)}px)`);
                        } else if (fontName.toLowerCase().includes('minecraft')) {
                            console.log(`‚úó Êú™ÊâæÂà∞: ${fontName} (Â∑ÆÂºÇÂ§™Â∞è: ${diff.toFixed(2)}px)`);
                        }
                    } catch (e) {
                        if (fontName.toLowerCase().includes('minecraft')) {
                            console.log(`‚úó ÈîôËØØ: ${fontName}`, e.message);
                        }
                    }
                });

                this.fonts = Array.from(detectedFonts).sort();
                console.log('‚úì ÊúÄÁªàÊ£ÄÊµãÂà∞ÁöÑÂ≠ó‰Ωì:', this.fonts);

                // Â¶ÇÊûú‰ªçÁÑ∂‰∏∫Á©∫ÔºåËØ¥ÊòéÈúÄË¶ÅÊèêÁ§∫Áî®Êà∑
                if (this.fonts.length === 0) {
                    console.warn('‚ö†Ô∏è Êú™ËÉΩÊ£ÄÊµãÂà∞‰ªª‰ΩïÂ≠ó‰Ωì„ÄÇËØ∑Á°Æ‰øùËá≥Â∞ëÂÆâË£Ö‰∫ÜÂü∫Êú¨Â≠ó‰Ωì„ÄÇ');
                }
            }

            // Ëé∑ÂèñÂèØËÉΩÁöÑÁ≥ªÁªüÂ≠ó‰ΩìÂàóË°®ÔºàÁî®‰∫éÊâ´ÊèèÔºâ
            getSystemFonts() {
                // ËøôÈáåÊòØ‰∏Ä‰∏™ÂåÖÂê´ÊâÄÊúâÂèØËÉΩÁöÑÁ≥ªÁªüÂ≠ó‰ΩìÁöÑÂàóË°®
                // Êàë‰ª¨Âè™ÊòØÁî®ÂÆÉÊù•Êâ´ÊèèÔºåÊúÄÁªàÂè™ËøîÂõûÂÆûÈôÖÂÆâË£ÖÁöÑ
                return [
                    // Ê†∏ÂøÉ Windows Â≠ó‰Ωì
                    'Arial', 'Arial Black', 'Calibri', 'Cambria', 'Cambria Math',
                    'Candara', 'Comic Sans MS', 'Consolas', 'Constantia', 'Corbel',
                    'Courier New', 'Ebrima', 'Franklin Gothic Medium', 'Garamond',
                    'Georgia', 'Helvetica', 'Impact', 'Javanese Text', 'Lucida Console',
                    'Lucida Handwriting', 'Lucida Sans', 'Lucida Sans Typewriter',
                    'Microsoft JhengHei', 'Microsoft Tai Le', 'Microsoft YaHei',
                    'Microsoft YaHei UI', 'Modern', 'Mongolian Baiti', 'Monotype Corsiva',
                    'MS Excel', 'MS Gothic', 'MS Outlook', 'MS PGothic', 'MS Reference Sans Serif',
                    'MS Word', 'Palatino Linotype', 'PMingLiU', 'Roman', 'Segoe Print',
                    'Segoe Script', 'Segoe UI', 'Segoe UI Historic', 'Segoe UI Symbol',
                    'SimSun', 'Tahoma', 'Times New Roman', 'Trebuchet MS', 'Verdana',
                    // Mac Â≠ó‰Ωì
                    'Apple Braille', 'Apple Chancery', 'Apple Color Emoji', 'Apple Symbols',
                    'AppleGothic', 'AppleMyungjo', 'Brush Script MT', 'Chalkboard',
                    'Chalkboard SE', 'Chalkduster', 'Didot', 'Herculanum',
                    'Helvetica', 'Helvetica Neue', 'Hoefler Text', 'Lucida Grande',
                    'Lucida Handwriting', 'Marker Felt', 'Monaco', 'Optima',
                    'Palatino', 'San Francisco', 'Symbol', 'Thonburi',
                    // Linux Â≠ó‰Ωì
                    'Abyssinica SIL', 'Andale Mono', 'Chilanka', 'Cascadia Code',
                    'Cascadia Mono', 'DejaVu Fonts', 'DejaVu Math TeX Gyre',
                    'DejaVu Sans', 'DejaVu Sans Mono', 'DejaVu Serif',
                    'DejaVu Serif Condensed', 'DejaVu Serif Extended',
                    'Droid Sans', 'Droid Serif', 'Lato', 'Liberation Fonts',
                    'Liberation Mono', 'Liberation Sans', 'Liberation Serif',
                    'Monospace', 'Noto Color Emoji', 'Noto Fonts', 'Noto Mono',
                    'Noto Sans', 'Noto Sans CJK JP', 'Noto Sans CJK KR',
                    'Noto Sans CJK SC', 'Noto Sans CJK TC', 'Noto Sans Mono',
                    'Noto Serif', 'Roboto', 'Roboto Condensed', 'Roboto Mono',
                    'Source Code Pro', 'Source Sans Pro', 'Source Serif Pro',
                    'Ubuntu', 'Ubuntu Condensed', 'Ubuntu Mono', 'VT323',
                    // ‰∏≠ÊñáÂ≠ó‰Ωì
                    'AR PL ShanHeiSun Uni', 'AR PL ZenKai Uni', 'DFKai-SB',
                    'HGMaruGothicMPRO', 'HGSGothicM', 'HGSoeiKakupoptai',
                    'HGÂâµËã±ËßíÔæéÔæüÔΩØÔæåÔæü‰Ωì', 'LiSu', 'Microsoft YaHei',
                    'Microsoft YaHei UI', 'Monotype Corsiva', 'MS ÊòéÊúù',
                    'MS „Ç¥„Ç∑„ÉÉ„ÇØ', 'NSimSun', 'SimHei', 'SimSun', 'SimSun-ExtB',
                    'ÂæÆËªüÊ≠£ÈªëÈ´î', 'ÂæÆËΩØÈõÖÈªë', '‰ªøÂÆã', '‰ªøÂÆã_GB2312',
                    'Ê•∑‰Ωì', 'Ê•∑‰Ωì_GB2312', 'Èö∂‰π¶', 'ÂÆã‰Ωì', 'ÂÆã‰Ωì_GB2312',
                    'Èªë‰Ωì', 'Èªë‰Ωì_GB2312',
                    // ÁâπÊÆäÂ≠ó‰Ωì
                    'Minecraft AE'
                ];
            }

            getFonts() {
                return this.fonts;
            }
        }

        const fontDetector = new FontDetector();

        // JSZip Â∫ì - Áî®‰∫éÊâìÂåÖÊñá‰ª∂

        let renderedFiles = []; // Â≠òÂÇ®ÁîüÊàêÁöÑÊñá‰ª∂
        let availableFonts = []; // Â≠òÂÇ®Ê£ÄÊµãÂà∞ÁöÑÂèØÁî®Â≠ó‰Ωì

        // Ê£ÄÊµãÁ≥ªÁªü‰∏≠ÂèØÁî®ÁöÑÂ≠ó‰Ωì
        async function detectAvailableFonts() {
            await fontDetector.detectSystemFonts();
            availableFonts = fontDetector.getFonts();
            updateFontSelect();
        }

        // Êõ¥Êñ∞Â≠ó‰ΩìÈÄâÊã©‰∏ãÊãâÂàóË°®
        function updateFontSelect() {
            const fontSearch = document.getElementById('fontSearch');
            const fontDropdown = document.getElementById('fontDropdown');
            const fontFamily = document.getElementById('fontFamily');
            
            fontDropdown.innerHTML = '';

            availableFonts.forEach(font => {
                const option = document.createElement('div');
                option.className = 'font-option';
                option.textContent = font;
                option.style.fontFamily = `"${font}", sans-serif`;
                option.dataset.font = font;
                
                option.addEventListener('click', () => {
                    fontFamily.value = font;
                    fontSearch.value = font;
                    fontDropdown.classList.remove('show');
                });
                
                fontDropdown.appendChild(option);
            });

            // ËÆæÁΩÆÈªòËÆ§ÈÄâÊã© - ‰ºòÂÖàMinecraft
            let selectedFont = 'Arial';
            if (availableFonts.find(f => f.toLowerCase().includes('minecraft'))) {
                selectedFont = availableFonts.find(f => f.toLowerCase().includes('minecraft'));
            } else if (availableFonts.includes('Microsoft YaHei')) {
                selectedFont = 'Microsoft YaHei';
            } else if (availableFonts.includes('Arial')) {
                selectedFont = 'Arial';
            }
            
            fontFamily.value = selectedFont;
            fontSearch.value = selectedFont;
        }

        // ÊêúÁ¥¢Â≠ó‰Ωì
        function searchFonts(query) {
            const fontDropdown = document.getElementById('fontDropdown');
            const fontOptions = fontDropdown.querySelectorAll('.font-option');
            const lowerQuery = query.toLowerCase();
            let hasMatch = false;

            fontOptions.forEach(option => {
                const fontName = option.dataset.font;
                if (fontName.toLowerCase().includes(lowerQuery)) {
                    option.style.display = 'block';
                    hasMatch = true;
                } else {
                    option.style.display = 'none';
                }
            });

            return hasMatch;
        }

        // Ê∑ªÂä†Ëá™ÂÆö‰πâÂ≠ó‰Ωì
        function addCustomFont() {
            const fontSearch = document.getElementById('fontSearch');
            const customFont = fontSearch.value.trim();

            if (!customFont) {
                alert('ËØ∑ËæìÂÖ•Â≠ó‰ΩìÂêçÁß∞');
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
            if (availableFonts.includes(customFont)) {
                alert('ËØ•Â≠ó‰ΩìÂ∑≤Â≠òÂú®');
                fontSearch.value = customFont;
                return;
            }

            // Ê∑ªÂä†Âà∞ÂàóË°®
            availableFonts.push(customFont);
            availableFonts.sort();

            // Êõ¥Êñ∞‰∏ãÊãâÊ°Ü
            updateFontSelect();

            // ËÆæÁΩÆ‰∏∫ÂΩìÂâçÈÄâ‰∏≠
            document.getElementById('fontFamily').value = customFont;
            fontSearch.value = customFont;

            console.log(`‚úì Â∑≤Ê∑ªÂä†Ëá™ÂÆö‰πâÂ≠ó‰Ωì: ${customFont}`);
            alert(`‚úì Â∑≤Ê∑ªÂä†Â≠ó‰Ωì: ${customFont}`);
        }

        // ‰∏ä‰º†Â≠ó‰ΩìÊñá‰ª∂
        function uploadFontFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const fontData = e.target.result;
                const fontName = file.name.split('.')[0]; // Ëé∑ÂèñÊñá‰ª∂Âêç‰Ωú‰∏∫Â≠ó‰ΩìÂêç
                
                // ÂàõÂª∫ @font-face
                const style = document.createElement('style');
                const fontUrl = URL.createObjectURL(new Blob([fontData], { type: file.type }));
                
                let fontFace = `@font-face {
                    font-family: "${fontName}";
                    src: url('${fontUrl}');
                }`;
                
                style.textContent = fontFace;
                document.head.appendChild(style);

                // Ê∑ªÂä†Âà∞Â≠ó‰ΩìÂàóË°®
                if (!availableFonts.includes(fontName)) {
                    availableFonts.push(fontName);
                    availableFonts.sort();
                    updateFontSelect();
                }

                // ËÆæÁΩÆ‰∏∫ÂΩìÂâçÈÄâ‰∏≠
                document.getElementById('fontFamily').value = fontName;
                document.getElementById('fontSearch').value = fontName;

                console.log(`‚úì Â∑≤Âä†ËΩΩÂ≠ó‰ΩìÊñá‰ª∂: ${fontName}`);
                alert(`‚úì Â∑≤Âä†ËΩΩÂ≠ó‰Ωì: ${fontName}`);
            };

            reader.readAsArrayBuffer(file);
        }

        // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊµãÂ≠ó‰Ωì
        window.addEventListener('load', async () => {
            await detectAvailableFonts();
            initFormatSelect();
            
            const fontSearch = document.getElementById('fontSearch');
            const fontDropdown = document.getElementById('fontDropdown');
            const fontFamily = document.getElementById('fontFamily');

            // ÊêúÁ¥¢ËæìÂÖ•
            fontSearch.addEventListener('input', (e) => {
                const query = e.target.value;
                if (query.trim()) {
                    searchFonts(query);
                    fontDropdown.classList.add('show');
                } else {
                    fontDropdown.classList.remove('show');
                }
            });

            // ÁÇπÂáªÊêúÁ¥¢Ê°ÜÊòæÁ§∫‰∏ãÊãâÂàóË°®
            fontSearch.addEventListener('focus', () => {
                if (fontSearch.value.trim()) {
                    fontDropdown.classList.add('show');
                } else {
                    // ÊòæÁ§∫ÂÖ®ÈÉ®Â≠ó‰Ωì
                    const fontOptions = fontDropdown.querySelectorAll('.font-option');
                    fontOptions.forEach(option => {
                        option.style.display = 'block';
                    });
                    fontDropdown.classList.add('show');
                }
            });

            // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ãÊãâÂàóË°®
            document.addEventListener('click', (e) => {
                if (!fontSearch.contains(e.target) && !fontDropdown.contains(e.target)) {
                    fontDropdown.classList.remove('show');
                }
            });
        });

        // ÂàùÂßãÂåñËæìÂá∫Ê†ºÂºèÈÄâÊã©Ê°Ü
        function initFormatSelect() {
            const formatOptions = [
                { value: 'webp', label: 'WebP (Êé®Ëçê)' },
                { value: 'png', label: 'PNG' },
                { value: 'jpg', label: 'JPG' },
                { value: 'svg', label: 'SVG' }
            ];

            const formatWrapper = document.getElementById('formatWrapper');
            const formatInput = document.getElementById('formatInput');
            const formatDropdown = document.getElementById('formatDropdown');
            const formatHidden = document.getElementById('format');

            // ÂàõÂª∫‰∏ãÊãâÈÄâÈ°π
            formatOptions.forEach(opt => {
                const option = document.createElement('div');
                option.className = 'select-option';
                option.textContent = opt.label;
                option.dataset.value = opt.value;

                if (opt.value === 'webp') {
                    option.classList.add('selected');
                }

                option.addEventListener('click', () => {
                    formatHidden.value = opt.value;
                    formatInput.innerHTML = opt.label + '<span class="select-arrow"></span>';
                    formatDropdown.classList.remove('show');
                    
                    // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
                    const allOptions = formatDropdown.querySelectorAll('.select-option');
                    allOptions.forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                });

                formatDropdown.appendChild(option);
            });

            // ÁÇπÂáªËæìÂÖ•Ê°ÜÂàáÊç¢‰∏ãÊãâÊ°Ü
            formatInput.addEventListener('click', () => {
                formatWrapper.classList.toggle('open');
                formatDropdown.classList.toggle('show');
            });

            // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
            document.addEventListener('click', (e) => {
                if (!formatWrapper.contains(e.target)) {
                    formatWrapper.classList.remove('open');
                    formatDropdown.classList.remove('show');
                }
            });
        }

        // Ê∑ªÂä†Êñ∞È°πÁõÆ
        function addItem() {
            const textList = document.getElementById('textList');
            const itemCount = textList.children.length;
            const newItem = document.createElement('div');
            newItem.className = 'input-item';
            newItem.innerHTML = `
                <div class="input-item-number">${itemCount + 1}</div>
                <input type="text" placeholder="ËæìÂÖ•Ë¶ÅÊ∏≤ÊüìÁöÑÊñáÂ≠ó...">
                <button onclick="removeItem(this)">Âà†Èô§</button>
            `;
            textList.appendChild(newItem);
            updateNumbers();
        }

        // Âà†Èô§È°πÁõÆ
        function removeItem(btn) {
            const textList = document.getElementById('textList');
            if (textList.children.length > 1) {
                btn.parentElement.remove();
                updateNumbers();
            } else {
                alert('Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏ÄÈ°πÔºÅ');
            }
        }

        // Êõ¥Êñ∞Â∫èÂè∑
        function updateNumbers() {
            const textList = document.getElementById('textList');
            Array.from(textList.children).forEach((item, index) => {
                item.querySelector('.input-item-number').textContent = index + 1;
            });
        }

        // Ëé∑ÂèñÊâÄÊúâËæìÂÖ•ÁöÑÊñáÂ≠ó
        function getTextItems() {
            const textList = document.getElementById('textList');
            return Array.from(textList.querySelectorAll('input')).map(input => input.value).filter(text => text.trim());
        }

        // ÂºÄÂßãÊ∏≤Êüì
        async function startRender() {
            const textItems = getTextItems();
            if (textItems.length === 0) {
                alert('ËØ∑Ëá≥Â∞ëËæìÂÖ•‰∏ÄÈ°πÊñáÂ≠óÔºÅ');
                return;
            }

            const fontFamily = document.getElementById('fontFamily').value;
            const fontSize = parseInt(document.getElementById('fontSize').value);
            const format = document.getElementById('format').value;

            // ÊòæÁ§∫ËøõÂ∫¶Êù°
            const progressContainer = document.getElementById('progressContainer');
            const renderBtn = document.getElementById('renderBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            
            progressContainer.style.display = 'flex';
            renderBtn.disabled = true;
            downloadBtn.style.display = 'none';
            renderedFiles = [];

            try {
                for (let i = 0; i < textItems.length; i++) {
                    const progress = Math.round((i / textItems.length) * 100);
                    updateProgress(progress, `Ê∏≤Êüì‰∏≠: ${i + 1}/${textItems.length}`);
                    
                    const canvas = createTextCanvas(textItems[i], fontFamily, fontSize);
                    const filename = `${String(i + 1).padStart(3, '0')}.${format}`;
                    const fileData = await canvasToFile(canvas, format);
                    
                    renderedFiles.push({
                        name: filename,
                        data: fileData
                    });
                    
                    await sleep(100); // ÁªôUIÊõ¥Êñ∞ÁöÑÊó∂Èó¥
                }

                updateProgress(100, 'Ê∏≤ÊüìÂÆåÊàêÔºÅ');
                await sleep(500);

                // ÈöêËóèËøõÂ∫¶Êù°ÔºåÊòæÁ§∫‰∏ãËΩΩÊåâÈíÆ
                progressContainer.style.display = 'none';
                downloadBtn.style.display = 'block';
                renderBtn.disabled = false;
            } catch (error) {
                console.error('Ê∏≤ÊüìÈîôËØØ:', error);
                alert('Ê∏≤ÊüìÂá∫Èîô: ' + error.message);
                progressContainer.style.display = 'none';
                renderBtn.disabled = false;
            }
        }

        // ÂàõÂª∫ÊñáÂ≠óÁîªÂ∏É
        function createTextCanvas(text, fontFamily, fontSize) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });

            // ËÆæÁΩÆÂ≠ó‰ΩìÂπ∂ÊµãÈáèÊñáÂ≠óÂÆΩÂ∫¶
            ctx.font = `bold ${fontSize}px "${fontFamily}", Arial, sans-serif`;
            ctx.textBaseline = 'top';
            
            const metrics = ctx.measureText(text);
            let textWidth = metrics.width;
            const textHeight = fontSize * 1.5;

            // ËÆæÁΩÆÁîªÂ∏ÉÂ§ßÂ∞èÔºàÊ∑ªÂä†ÂÜÖËæπË∑ùÔºâ
            const padding = fontSize * 0.3;
            canvas.width = Math.max(textWidth + padding * 2, 100);
            canvas.height = Math.max(textHeight + padding * 2, 50);

            // ÈáçÊñ∞Ëé∑Âèñ contextÔºàË∞ÉÊï¥Â§ßÂ∞èÂêéÈúÄË¶ÅÈáçÊñ∞ËÆæÁΩÆÂ≠ó‰ΩìÔºâ
            const ctx2 = canvas.getContext('2d', { willReadFrequently: true });

            // ÁªòÂà∂ËÉåÊôØ
            ctx2.fillStyle = '#ffffff';
            ctx2.fillRect(0, 0, canvas.width, canvas.height);

            // ÁªòÂà∂ÊñáÂ≠ó
            ctx2.fillStyle = '#000000';
            ctx2.font = `bold ${fontSize}px "${fontFamily}", Arial, sans-serif`;
            ctx2.textBaseline = 'top';
            ctx2.antialias = 'subpixel';
            ctx2.fillText(text, padding, padding);

            return canvas;
        }

        // Canvas ËΩ¨Êñá‰ª∂
        async function canvasToFile(canvas, format) {
            return new Promise((resolve, reject) => {
                canvas.toBlob(
                    blob => resolve(blob),
                    `image/${format === 'jpg' ? 'jpeg' : format}`,
                    0.95
                );
            });
        }

        // Áù°Áú†ÂáΩÊï∞
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Êõ¥Êñ∞ËøõÂ∫¶Êù°
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // ‰∏ãËΩΩ ZIP
        async function downloadZip() {
            if (!window.JSZip) {
                alert('Ê≠£Âú®Âä†ËΩΩÂéãÁº©Â∫ìÔºåËØ∑Á®çÂÄô...');
                await sleep(1000);
                if (!window.JSZip) {
                    alert('ÂéãÁº©Â∫ìÂä†ËΩΩÂ§±Ë¥•');
                    return;
                }
            }

            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.disabled = true;
            downloadBtn.textContent = '‚è≥ ÊâìÂåÖ‰∏≠...';

            try {
                const zip = new JSZip();
                
                for (const file of renderedFiles) {
                    zip.file(file.name, file.data);
                }

                const blob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'render.zip';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                downloadBtn.textContent = '‚¨áÔ∏è ‰∏ãËΩΩ ZIP';
                downloadBtn.disabled = false;
            } catch (error) {
                console.error('ÊâìÂåÖÈîôËØØ:', error);
                alert('ÊâìÂåÖÂá∫Èîô: ' + error.message);
                downloadBtn.textContent = '‚¨áÔ∏è ‰∏ãËΩΩ ZIP';
                downloadBtn.disabled = false;
            }
        }

        // ÂõûËΩ¶Ê∑ªÂä†
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
                addItem();
                e.target.nextElementSibling.nextElementSibling.click();
            }
        });
    </script>
</body>
</html>